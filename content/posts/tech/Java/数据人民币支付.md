---
title: "数据人民币支付"
date: 2022-09-05T00:17:58+08:00
lastmod: 2022-09-05T00:17:58+08:00
author: ["藏锋"]
keywords: 
- jvm
categories: 
- tech
tags: 
- java
- tech
description: "数据人民币支付-对接苏州建行"
weight:
slug: ""
draft: false # 是否为草稿
comments: true
reward: true # 打赏
mermaid: true #是否开启mermaid
showToc: true # 显示目录
TocOpen: true # 自动展开目录
hidemeta: false # 是否隐藏文章的元信息，如发布日期、作者等
disableShare: true # 底部不显示分享栏
showbreadcrumbs: true #顶部显示路径
cover:
    image: "" #图片路径例如：posts/tech/123/123.png
    caption: "" #图片底部描述
    alt: ""
    relative: false
---

数字货币支付，是对接的建行熊猫支付，通过微信小程序，跳转至建行数字货币支付的小程序中，进行支付
## 小程序支付

## 支付逻辑
后端：根据订单价格，商户号等，生成URL
小程序：根据将URL传入到建行指定的小程序
``` js
小程序跳转代码，其中appId是写死的，URL从接口中获取即可
toCNY(info) {
				uni.navigateToMiniProgram({
					appId: 'wx787d6b09da4e3a96',
					path: "pages/home/home?time:" + new Date().getTime(),
					extraData: {
						URL: info,
					},
					envVersion: 'release',
					success: (res) => {
						
						console.log('enter');
					},
					fail: (err) => {
						console.log('enter fail');
						// toast.showError("操作失败")
					}
				})
			},
```
 
 
需要提前申请好商户信息，公钥需要完整的才能进行查询
## 配置项
```yml
digital:  
  pay: #数字支付配置项  
    ccb_host: https://ch5.dcep.ccb.com/CCBIS/ccbMain_XM  #建行互联网熊猫支付  
    ccb_query_host: https://ch5.dcep.ccb.com/CCBIS/B2CMainPlat_00_PD_BEPAY #查询URL  
    CCB_IBSVersion: V6  
    Mrch_url: https://ywc.yijiahe.com/oc-app/applets/pay/digital-callback  
    MERCHANTID:  777000557324015  
    POSID: '068901420'  
    BRANCHID: 322000000  
    PUB: 8ecf389dfbb9b061c8c6c3bf020111 #公钥
```

## 生成支付的URL
```java
OrderInfo orderInfo = Optional.ofNullable(orderInfoMapper.selectById(orderId)).orElseThrow(() -> new BizException("A03000", "订单不存在"));  
log.info("准备数字支付, orderid is {}", orderId);  
if (orderInfo.getTotalPrice() == null) {  
    throw new RuntimeException("支付金额为空");  
}  
MacParams macParams = new MacParams();  
macParams.setMERCHANTID(cCBPayParams.getMERCHANTID());  
macParams.setBRANCHID(cCBPayParams.getBRANCHID());  
BigDecimal bigDecimal = new BigDecimal(orderInfo.getTotalPrice() / 100.00).setScale(2, RoundingMode.HALF_UP);  
macParams.setPAYMENT(bigDecimal.doubleValue());  
macParams.setORDERID(orderId);  
macParams.setCURCODE("01");  
macParams.setREMARK1(orderInfo.getUserId().toString());  
macParams.setPOSID(cCBPayParams.getPOSID());  
macParams.setPUB(cCBPayParams.getPUB());  
String md5Url = getFiledsInfo(macParams).substring(1);  
  
String mac = md5(md5Url);  
int i = md5Url.indexOf("&PUB=");  
//获取签名内容原串  
String strSrc = md5Url.substring(0, i);  
//拼接请求串  
String url = ccbHost + "?CCB_IBSVersion=" + CCBIBSVersion + "&" + strSrc + "&MAC=" + mac + "&Mrch_url=" + Mrch_url + "&TX_FLAG=3";  
log.info("sendUrl={}", url);  
return url;
```

## 支付查询
根据订单号，查询是否支付成功，刷新支付记录：
```Java
String result = "";  
OrderInfo orderInfo = xxx
CCBQueryParams queryParams = new CCBQueryParams();  
queryParams.setMERCHANTID(cCBPayParams.getMERCHANTID());  
queryParams.setBRANCHID(cCBPayParams.getBRANCHID());  
queryParams.setPOSID(cCBPayParams.getPOSID());  
queryParams.setOrdr_ID(orderId.toString());  
  
cCBPayParams.setSYS_TX_STATUS("00");  
  
String pub = cCBPayParams.getPUB();  
  
String paramsUrl = getFiledsInfo(queryParams).substring(1);  
log.info("paramsUrl={}", paramsUrl);  
//执行加密操作  
CCBPayUtil ccbPayUtil = new CCBPayUtil();  
String ccbParam = ccbPayUtil.makeCCBParam(paramsUrl, pub);  
//拼接请求串  
String url = ccbQueryHost + "?CCB_IBSVersion=" + CCBIBSVersion + "&" + paramsUrl + "&ccbParam=" + ccbParam;  
log.info("sendUrl={}", url);  
String data = HttpClients.post(url, new HashMap<>());  
log.info("receivedData={}", data);  
CCBPayResult ccbPayResult = JSON.parseObject(data, CCBPayResult.class);  
if (ccbPayResult == null) {  
    return "数字支付侧订单查询无支付结果,请稍后重试";  
}  
BigDecimal bigDecimal = new BigDecimal(orderInfo.getTotalPrice() / 100.00).setScale(2, RoundingMode.HALF_UP);  
double amount = bigDecimal.doubleValue();  
for (CCBPayResult.Detail_Grp grp : ccbPayResult.getDetail_Grp()) {  
    if (grp.getORDERID().equals(orderId.toString()) && grp.getSTATUSCODE().equals("00") && grp.getAMOUNT().equals(amount)) {  
        log.info("数字支付订单回调成功");  
        orderService.updateOrderStatus(orderId, PAID, OrderInfoVO.builder().payMethod(DIGITAL.getCode()).build());  
        PayRecord payRecord = new PayRecord();  
        payRecord.setPayMerchantid(cCBPayParams.getMERCHANTID());  
        payRecord.setPayPrice(orderInfo.getTotalPrice());  
        payRecord.setOrderId(orderId);  
        payRecord.setType(1);  
        saveRecord(payRecord, 1);  
        return "订单支付成功,支付记录已保存";  
    }  
}  
return ccbPayResult.toString();
```

## 回调
```java
if (!cCBPayParams.getPOSID().equals(result.getPOSID()) || !cCBPayParams.getBRANCHID().equals(result.getBRANCHID())) {  
    log.info("URL解析参数：{},非本公司商户信息", result);  
    throw new BizException(DIGITAL_POSID_ERROR);  
}  
//商户柜台完整公钥  
String pubKey = "1234567";  
String strSrc = "";  
String sign = result.getSIGN();  
try {  
    int i = param.indexOf("&SIGN=");  
    //获取签名内容原串  
    strSrc = param.substring(0, i);  
} catch (Exception e) {  
    log.error("签名内容原串获取失败");  
}  
CCBPayUtil ccbPayUtil = new CCBPayUtil();  
boolean isSign = ccbPayUtil.verifyNotifySign(strSrc, sign, pubKey);  
  
if (isSign) {  
    Long orderId = Long.valueOf(result.getORDERID());  
    OrderInfo orderInfo = Optional.ofNullable(orderInfoMapper.selectById(orderId)).orElseThrow(() -> new BizException("666", "订单不存在"));  
    BigDecimal bigDecimal = new BigDecimal(orderInfo.getTotalPrice() / 100.00).setScale(2, RoundingMode.HALF_UP);  
  
    if (result.getSUCCESS().equals("Y") && result.getPAYMENT().equals(bigDecimal.toString())) {  
        log.info("数字支付订单回调成功");  
        orderService.updateOrderStatus(orderId, PAID, OrderInfoVO.builder().payMethod(DIGITAL.getCode()).build());  
        PayRecord payRecord = new PayRecord();  
        payRecord.setPayMerchantid(cCBPayParams.getMERCHANTID());  
        payRecord.setPayPrice(orderInfo.getTotalPrice());  
        payRecord.setOrderId(orderId);  
        payRecord.setType(1);  
        saveRecord(payRecord, 1);  
        return "订单支付成功,支付记录已保存";  
    } else {  
        log.error("回调参数不匹配：{}", result);  
    }  
    strSrc = "签名验证成功";
```


当前只实现了支付，回调，查询功能，退款功能还未实现


瓦片--退款和对账
1.参数加密，接入sevlet地址，请求授权
2.获取授权结果，解析 --得到token，通讯明文，ACC_ENTRY（商户地址）
3.退款参数加密，接入商户，发起退款请求--->通讯明文对退款结果集解密

FT_CORPID：调用方ID（FTC_sugwrobot）
FT_TILEID：瓦片Id（07VMCX001）
FT_SCENARIO：接口使用场景（sugwrobot）

公钥pubKey1 =xxx
私钥priKey1 = xxx

公钥pubKey2 = xxx



/logs/nginx/oc.access.log
数字货币支付回调，nginx的日志：

219.142.89.13 - - [13/Sep/2022:15:39:08 +0800] "POST /app/pay/digital-callback?POSID=123&BRANCHID=222&ORDERID=3333&PAYMENT=0.01&CURCODE=01&REMARK1=222&REMARK2=&ACC_TYPE=04&SUCCESS=Y&TYPE=1&REFERER=&CLIENTIP=1.1.1.1&SIGN=56e4a2ae874cc8fcfb98c4544aefc2855e621dbae9b94b43f5c5f12de7ba591fb0ed4cfce20b181f81af424e13dc535b7a560a3bdd3999a3c03b5cc121821e64e616a86342b73fb08be79f122928069933525dbee63b48b1904d6b5deb9486150c981c90d142d8e8130f292ec68bf8bd1feebf95f6136de30cf2cf1b7bf40724 HTTP/1.1" 200 80 "-" "Jakarta Commons-HttpClient/3.1"
